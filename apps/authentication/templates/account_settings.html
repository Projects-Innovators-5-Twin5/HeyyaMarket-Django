{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Account settings - Account{% endblock %}

{% block page_js %}
{{ block.super }}
<script src="{% static 'js/pages-account-settings-account.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const forms = ['formAccountSettings', 'brandDetailsForm', 'brandRequestModal'];

  forms.forEach((formId) => {
    const form = document.getElementById(formId);
    if (form) {
      form.querySelectorAll('input, textarea').forEach((input) => {
        input.addEventListener('input', () => validateInput(input));
      });
    }
  });

  function validateInput(input) {
    const errorElement = document.getElementById(`${input.id}_error`);
    if (input.checkValidity()) {
      input.classList.remove('is-invalid');
      input.classList.add('is-valid');
      if (errorElement) {
        errorElement.textContent = '';
        errorElement.style.display = 'none';
      }
    } else {
      input.classList.remove('is-valid');
      input.classList.add('is-invalid');
      if (errorElement) {
        errorElement.textContent = getErrorMessage(input);
        errorElement.style.display = 'block';
      }
    }
  }

  function getErrorMessage(input) {
    if (input.validity.valueMissing) {
      return 'This field is required.';
    } else if (input.validity.typeMismatch) {
      return 'Please enter a valid value.';
    } else if (input.validity.tooShort) {
      return `Please enter at least ${input.minLength} characters.`;
    } else if (input.validity.patternMismatch) {
      return 'Please match the required pattern.';
    } else if (input.validity.rangeUnderflow) {
      return 'The value is too low.';
    }
    return 'Invalid input.';
  }
});
</script>

<style>
  .invalid-feedback {
    color: red;
    display: block;
  }
  .is-valid {
    border-color: #28a745 !important;
  }
  .is-invalid {
    border-color: #dc3545 !important;
  }
</style>
{% endblock page_js %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <div class="card mb-6">
      <form id="formAccountSettings" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="card-body">
          <h4> Personal Informations </h4>
          <div class="d-flex align-items-start align-items-sm-center gap-6">
            <img src="{{ user.profile_photo.url }}" alt="user-avatar" class="d-block w-px-100 h-px-100 rounded" id="uploadedAvatar" />
            <div class="button-wrapper">
              <label for="profile_photo" class="btn btn-sm btn-primary me-3 mb-4" tabindex="0">
                <span class="d-none d-sm-block">Upload new photo</span>
                <i class="ri-upload-2-line d-block d-sm-none"></i>
                <input type="file" class="account-file-input" id="profile_photo" name="profile_photo" hidden accept="image/png, image/jpeg" />
              </label>
              <button type="button" class="btn btn-sm btn-outline-danger account-image-reset mb-4">
                <i class="ri-refresh-line d-block d-sm-none"></i>
                <span class="d-none d-sm-block">Reset</span>
              </button>
              <div>Allowed JPG, GIF or PNG. Max size of 800K</div>
            </div>
          </div>
        </div>
        <div class="card-body pt-0">
          <div class="row mt-1 g-5">
            <div class="col-md-6">
              <div class="form-floating form-floating-outline">
                <input class="form-control" type="text" id="first_name" name="first_name" value="{{ user.first_name }}" required minlength="2" />
                <label for="first_name">First Name</label>
                <div class="invalid-feedback" id="first_name_error"></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating form-floating-outline">
                <input class="form-control" type="text" name="last_name" id="last_name" value="{{ user.last_name }}" required minlength="2" />
                <label for="last_name">Last Name</label>
                <div class="invalid-feedback" id="last_name_error"></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating form-floating-outline">
                <input class="form-control" type="email" id="email" name="email" value="{{ user.email }}" placeholder="john.doe@example.com" required />
                <label for="email">E-mail</label>
                <div class="invalid-feedback" id="email_error"></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating form-floating-outline">
                <input type="tel" class="form-control" id="tel" name="tel" value="{{ user.tel }}" pattern="^\d{8,14}$" required />
                <label for="tel">Phone Number</label>
                <div class="invalid-feedback" id="tel_error"></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating form-floating-outline">
                <input type="text" class="form-control" id="addresse" name="addresse" value="{{ user.addresse }}" required minlength="5" />
                <label for="addresse">Address</label>
                <div class="invalid-feedback" id="addresse_error"></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating form-floating-outline">
                <textarea class="form-control" id="bio" name="bio" minlength="10" maxlength="200">{{ user.bio }}</textarea>
                <label for="bio">Bio</label>
                <div class="invalid-feedback" id="bio_error"></div>
              </div>
            </div>
          </div>
          <div class="mt-6">
            <button type="submit" class="btn btn-primary me-3">Save changes</button>
            <button type="reset" class="btn btn-outline-secondary">Reset</button>
          </div>
          </div>


        </form>
      </div>


    <div class="col-md-12 mt-4 mb-4">
      {% if user.role == 'CLIENT' %}
        {% if user.request_status == 'pending' %}
          <p class="text-warning">Request is sent, waiting for validation.</p>
        {% else %}
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#brandRequestModal">
            Become a Vendeur
          </button>
        {% endif %}
      {% elif user.role == 'VENDEUR' %}
        <div class="card">
          <div class="card-header">
            <h5>Brand Details</h5>
          </div>
          <div class="card-body">
            <form id="brandDetailsForm" method="POST" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="row mt-1 g-5">
                <div class="col-md-6">
                  <div class="form-floating form-floating-outline">
                    <input class="form-control" type="text" id="brand_name" name="brand_name" value="{{ user.brand_name }}" required minlength="2" />
                    <label for="brand_name">Brand Name</label>
                    <div class="invalid-feedback" id="brand_name_error"></div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating form-floating-outline">
                    <textarea class="form-control" id="brand_description" name="brand_description" required minlength="10">{{ user.brand_description }}</textarea>
                    <label for="brand_description">Brand Description</label>
                    <div class="invalid-feedback" id="brand_description_error"></div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating form-floating-outline">
                    <input type="email" class="form-control" id="brand_email" name="brand_email" value="{{ user.brand_email }}" required />
                    <label for="brand_email">Brand E-mail</label>
                    <div class="invalid-feedback" id="brand_email_error"></div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-floating form-floating-outline">
                    <input type="number" class="form-control" id="brand_rne_number" name="brand_rne_number" value="{{ user.brand_rne_number }}" required min="1" />
                    <label for="brand_rne_number">Brand RNE Number</label>
                    <div class="invalid-feedback" id="brand_rne_number_error"></div>
                  </div>
                </div>
              <div class="col-md-12">
              <div class="mb-3">
               <label for="brand_logo" class="form-label">Brand Logo</label>
               <input type="file" class="form-control" id="brand_logo" name="brand_logo" accept="image/*"  />
                    {% if user.brand_logo %}
                        <img src="{{ user.brand_logo.url }}" alt="Brand Logo" class="d-block w-px-100 h-px-100 rounded mt-2" />
                   {% else %}
                      <p>No logo uploaded</p>
                    {% endif %}
              </div>
              </div>

              </div>
              <div class="mt-4">
                <button type="submit" name="brand_request" class="btn btn-primary me-3">Update Brand</button>
                <button type="reset" class="btn btn-outline-secondary">Reset</button>
              </div>
            </form>
          </div>
        </div>
      {% endif %}
    </div>

  <div class="modal fade" id="brandRequestModal" tabindex="-1" aria-labelledby="brandRequestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="brandRequestModalLabel">Request to become a Vendeur</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="brandRequestModal" method="POST" enctype="multipart/form-data" >
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="form-floating form-floating-outline">
                                <input class="form-control" type="text" id="brand_name" name="brand_name" required minlength="2" />
                                <label for="brand_name">Brand Name</label>
                                <div class="invalid-feedback" id="brand_name_error"></div>  <!-- Changed feedback ID -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating form-floating-outline">
                                <textarea class="form-control" id="brand_description" name="brand_description" required minlength="10"></textarea>
                                <label for="brand_description">Brand Description</label>
                                <div class="invalid-feedback" id="brand_description_error"></div>  <!-- Changed feedback ID -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating form-floating-outline">
                                <input type="email" class="form-control" id="brand_email" name="brand_email" required />
                                <label for="brand_email">Brand E-mail</label>
                                <div class="invalid-feedback" id="brand_email_error"></div>  <!-- Changed feedback ID -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating form-floating-outline">
                                <input type="number" class="form-control" id="brand_rne_number" name="brand_rne_number" required min="1" />
                                <label for="brand_rne_number">Brand RNE Number</label>
                                <div class="invalid-feedback" id="brand_rne_number_error"></div>  <!-- Changed feedback ID -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="brand_logo" class="form-label">Brand Logo</label>
                            <input class="form-control" type="file" id="brand_logo" name="brand_logo" accept="image/png, image/jpeg" />
                            <div class="invalid-feedback" id="brand_logo_error"></div>  <!-- Changed feedback ID -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" name="brand_request" class="btn btn-primary">Send Request</button>
                </div>
            </form>
        </div>
    </div>
</div>


    <div class="col-12 mt-4">
      <div class="card mb-4">
        <h5 class="card-header">Delete Account</h5>
        <div class="card-body">
          <form method="POST">
            {% csrf_token %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="deleteAccount" required />
              <label class="form-check-label" for="deleteAccount">
                I confirm my account deletion
              </label>
              <div class="invalid-feedback">You must confirm account deletion.</div>
            </div>
            <button type="submit" class="btn btn-danger mt-3">Delete Account</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}
